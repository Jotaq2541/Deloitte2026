
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deloitte | Asistente Interactivo</title>
  <meta name="description" content="Asistente interactivo con avatar hologrÃ¡fico (mujer latina) y voz latina neutra." />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://upload.wikimedia.org/wikipedia/commons/3/3a/Deloitte_logo.png" alt="Deloitte" height="26">
      <h1>Asistente Interactivo â€“ Congreso</h1>
    </div>
    <div class="row">
      <label>Idioma:
        <select id="lang">
          <option value="es-ES" selected>EspaÃ±ol</option>
          <option value="en-US">English</option>
          <option value="pt-BR">PortuguÃªs</option>
        </select>
      </label>
      <label>Voz:
        <select id="voiceSel" title="Selecciona la voz"></select>
      </label>
      <span id="sttStatus" class="pill">Voz: inactivo</span>
    </div>
  </header>

  <main class="wrap">
    <!-- Izquierda: Avatar hologrÃ¡fico + Controles -->
    <section class="left">
      <div class="avatar card" id="avatar">
        <video id="avatarVideo" autoplay muted loop playsinline preload="auto">
          <source src="assets/avatar-holo.mp4" type="video/mp4">
        </video>
        <div class="scanlines"></div>
        <div class="subtitle" id="subs"></div>
      </div>

      <div class="card">
        <div class="switches">
          <label><input type="checkbox" class="domain" value="deloitte" checked /> Deloitte</label>
          <label><input type="checkbox" class="domain" value="ciber" checked /> Ciberseguridad</label>
          <label><input type="checkbox" class="domain" value="legal" checked /> Legal</label>
          <label><input type="checkbox" class="domain" value="economico" checked /> EconÃ³mico</label>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnMic" class="btn-primary">ğŸ¤ Pulsar para hablar</button>
          <button id="btnStop">â¹ï¸ Parar voz</button>
          <span class="pill" id="conn">ConexiÃ³n: local</span>
        </div>
        <div class="disclaimer" id="domDisclaimer" style="margin-top:8px">
          <strong>Aviso:</strong> Respuestas con fines informativos; no constituyen asesorÃ­a legal, financiera o tÃ©cnica.
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content: space-between;">
          <span class="meta">Sin backend: modo demo (eco). Con backend: respuestas reales.</span>
          <button id="btnClear">ğŸ§¹ Limpiar</button>
        </div>
      </div>
    </section>

    <!-- Derecha: Chat -->
    <section class="right">
      <div class="chat-header">
        <h2>Chat con el avatar</h2>
        <span id="status" class="meta">Listo</span>
      </div>
      <div id="chat" class="chat" aria-live="polite"></div>
      <div class="composer">
        <input id="input" type="text" placeholder="Escribe tu preguntaâ€¦" />
        <button id="send" class="btn-primary">Enviar</button>
        <button id="speak" title="Repetir Ãºltima respuesta">ğŸ”Š</button>
      </div>
      <div class="disclaimer">
        Ejemplos: â€œservicios de Deloitteâ€, â€œtendencias de ciberseguridadâ€, â€œriesgos legales de IAâ€, â€œpanorama econÃ³micoâ€.
      </div>
    </section>
  </main>

  <footer>
    <small class="meta">Â© Deloitte â€“ Demo de asistente con voz y avatar hologrÃ¡fico para congreso.</small>
  </footer>

  <script src="assets/config.js"></script>
  <script>
    // ---------- DOM ----------
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const speakBtn = document.getElementById('speak');
    const micBtn = document.getElementById('btnMic');
    const stopBtn = document.getElementById('btnStop');
    const sttStatus = document.getElementById('sttStatus');
    const statusEl = document.getElementById('status');
    const subs = document.getElementById('subs');
    const conn = document.getElementById('conn');
    const langSel = document.getElementById('lang');
    const voiceSel = document.getElementById('voiceSel');
    const avatar = document.getElementById('avatar');

    // ---------- Utilidades ----------
    function addMsg(role, text, citas=[]) {
      const wrap = document.createElement('div');
      wrap.className = `msg ${role}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = role === 'me' ? 'TÃº' : 'Asistente';
      wrap.appendChild(bubble); wrap.appendChild(meta);

      if (role === 'ai' && citas?.length) {
        const c = document.createElement('div');
        c.className = 'citas';
        c.innerHTML = 'Fuentes: ' + citas.map(x => `<a href="${x.url}" target="_blank">${x.titulo || x.url}</a>`).join(' Â· ');
        wrap.appendChild(c);
      }
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function setStatus(t) { statusEl.textContent = t }

    function getDomains() {
      return Array.from(document.querySelectorAll('.domain:checked')).map(x => x.value);
    }
    function buildDisclaimer(domains) {
      const map = {
        legal: "Esta respuesta es informativa y no constituye asesorÃ­a legal.",
        economico: "No es asesorÃ­a financiera o de inversiÃ³n.",
        ciber: "Sigue buenas prÃ¡cticas (NIST/ISO); evalÃºa tu contexto.",
        deloitte: "InformaciÃ³n general basada en materiales pÃºblicos."
      };
      const msgs = Array.from(new Set(domains.map(d => map[d]).filter(Boolean)));
      return msgs.length ? msgs.join(' ') : "Contenido informativo; puede requerir validaciÃ³n por especialistas de Deloitte.";
    }

    // ---------- TTS (Text-to-Speech) ----------
    let chosenVoice = null;
    function populateVoices() {
      if (!('speechSynthesis' in window)) return;
      const voices = window.speechSynthesis.getVoices() || [];
      const preferred = ['es-419', 'es-MX', 'es-CO', 'es-ES'];
      const sorted = voices.sort((a,b)=> preferred.indexOf(a.lang) - preferred.indexOf(b.lang));
      voiceSel.innerHTML = '';
      sorted.forEach(v => {
        if (v.lang?.startsWith('es')) {
          const opt = document.createElement('option');
          opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`;
          voiceSel.appendChild(opt);
        }
      });
      chosenVoice = sorted.find(v => preferred.includes(v.lang)) || sorted.find(v => v.lang?.startsWith('es')) || null;
      if (chosenVoice) voiceSel.value = chosenVoice.name;
    }
    if ('speechSynthesis' in window) {
      window.speechSynthesis.onvoiceschanged = populateVoices;
      populateVoices();
    }
    voiceSel.onchange = () => {
      const voices = speechSynthesis.getVoices();
      chosenVoice = voices.find(v => v.name === voiceSel.value) || null;
    };

    function setTalking(on) {
      avatar.classList.toggle('talking', on);
      if (!on) subs.textContent = '';
    }
    function speak(text, lang='es-ES') {
      if (!window.speechSynthesis) return;
      try { window.speechSynthesis.cancel(); } catch(e){}
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = chosenVoice?.lang || lang;
      if (chosenVoice) utter.voice = chosenVoice;
      utter.rate = 1.02; utter.pitch = 1.0;
      utter.onstart = () => setTalking(true);
      utter.onend = () => setTalking(false);
      utter.onerror = () => setTalking(false);
      subs.textContent = text;
      window.speechSynthesis.speak(utter);
    }
    stopBtn.onclick = () => { if (window.speechSynthesis) window.speechSynthesis.cancel(); setTalking(false); };
    speakBtn.onclick = () => {
      const aiNodes = Array.from(document.querySelectorAll('.msg.ai .bubble'));
      if (aiNodes.length) speak(aiNodes[aiNodes.length-1].textContent, langSel.value);
    };

    // ---------- STT (Speech-to-Text) ----------
    let recognizing = false, recognition;
    function initSTT() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { sttStatus.textContent = 'Voz: no disponible'; sttStatus.className='pill err'; return; }
      recognition = new SR();
      recognition.lang = langSel.value || 'es-ES';
      recognition.interimResults = true; recognition.continuous = false;
      recognition.onstart = () => { recognizing = true; sttStatus.textContent = 'Voz: escuchandoâ€¦'; sttStatus.className='pill ok'; };
      recognition.onend = () => { recognizing = false; sttStatus.textContent = 'Voz: inactivo'; sttStatus.className='pill'; };
      recognition.onerror = () => { recognizing = false; sttStatus.textContent = 'Voz: error'; sttStatus.className='pill err'; };
      recognition.onresult = (ev) => {
        let final = '';
        for (const res of ev.results) if (res.isFinal) final += res[0].transcript;
        if (final) { inputEl.value = final.trim(); sendBtn.click(); }
      };
    }
    micBtn.onclick = () => { if (recognition && !recognizing) recognition.start(); };
    langSel.onchange = () => { if (recognition) recognition.lang = langSel.value; };
    initSTT();

    // ---------- Backend (con fallback demo) ----------
    async function askLLM(question) {
      const payload = {
        question,
        lang: langSel.value,
        domains: getDomains(),
        session: sessionStorage.getItem('sess') || crypto.randomUUID(),
      };
      sessionStorage.setItem('sess', payload.session);

      const base = (window.API_BASE || '').replace(/\/$/, '');
      if (!base) {
        // Sin backend â†’ demo
        return {
          answer: `Demo: me preguntaste Â«${question}Â». ConectarÃ© al backend cuando estÃ© disponible.`,
          citations: [],
          disclaimer: buildDisclaimer(payload.domains)
        };
      }
      const url = `${base}/api/chat`;

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch (e) {
        return {
          answer: `No pude contactar la API en este momento.\n\nDetalle: ${e.message}`,
          citations: [],
          disclaimer: buildDisclaimer(payload.domains)
        };
      }
    }

    async function handleSend() {
      const q = (inputEl.value || '').trim();
      if (!q) return;
      inputEl.value = '';
      addMsg('me', q);
      setStatus('Pensandoâ€¦');

      const res = await askLLM(q);
      const text = [res.answer, res.disclaimer ? `\n\nâ€” ${res.disclaimer}` : ''].join('');
      addMsg('ai', text, res.citations || []);
      setStatus('Listo');
      speak(text, langSel.value);
    }

    sendBtn.onclick = handleSend;
    inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });

    document.getElementById('btnClear').onclick = () => {
      chatEl.innerHTML = '';
      setStatus('ConversaciÃ³n reiniciada');
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      setTalking(false);
    };

    // Disclaimers dinÃ¡micos
    const domDisclaimer = document.getElementById('domDisclaimer');
    const refreshDisclaimer = () => { domDisclaimer.textContent = buildDisclaimer(getDomains()); };
    document.querySelectorAll('.domain').forEach(chk => chk.addEventListener('change', refreshDisclaimer));
    refreshDisclaimer();

    // Ping de conexiÃ³n
    (async () => {
      if (!window.API_BASE) return; // sigue local
      try {
        const pong = await fetch((window.API_BASE.replace(/\/$/,'') + '/api/chat'), { method: 'OPTIONS' });
        if (pong.ok) { conn.textContent = 'ConexiÃ³n: backend'; conn.className='pill ok'; }
      } catch(e) { /* se queda local */ }
    })();

    // Mensaje de bienvenida personalizable (frontend)
    window.onload = () => {
      const welcome = "Â¡Hola! Bienvenido o bienvenida al asistente interactivo de Deloitte. Puedo contarte sobre nuestros servicios, el Marketplace y temas de ciberseguridad, legales y econÃ³micos.";
      addMsg('ai', welcome);
      speak(welcome, 'es-ES');
    };
  </script>
</body>
</html>
